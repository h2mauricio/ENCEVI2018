---
title: "Electricity Bills Analysis - ENCEVI 2018"
author: "[Mauricio Hernandez](http://mauricioh2.com)"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    code_folding: hide
    self_contained: true
    thumbnails: true
    lightbox: false
    highlight: tango
---

```{r}
#Remove all objects from current workspace and call garbage collector
rm(list=ls())
gc()
```

```{r sh, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
source("./script/general_setup_functions.R")
```

```{r knitr_init, echo=FALSE, results="asis",  message=FALSE, cache=FALSE, warning=FALSE}
#options(max.print = "75")
UsePackage("knitr")
opts_chunk$set(echo = FALSE,
	             cache = FALSE,
               prompt = FALSE,
               tidy = FALSE,
               comment = NA,
               message=FALSE,
               warning=FALSE
               )
opts_knit$set(width = 100,
           #plain.ascii = FALSE,       # This is very handy in all Rmd documents
           #style = "rmarkdown",        # This too
           footnote = NA,             # Avoids footnotes which would clutter the results
           subtitle.emphasis = FALSE)  # This is a setting to experiment with - according to)
```

```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
#devtools::install_github("ropensci/plotly")
```

```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
Sys.setenv("plotly_username" = "mauricioh2")
Sys.setenv("plotly_api_key" = "CzXpBQKn6zRQj1ExEd5O")
```

```{r load_packages, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
##Load and attach add-on packages
UsePackage('ProjectTemplate')
UsePackage('stringr')
UsePackage('psych')
UsePackage('ggplot2')
UsePackage('dplyr') 
UsePackage('reshape2')
UsePackage('plotly')
UsePackage('processx')
UsePackage('doBy')
UsePackage('foreign')   
UsePackage('survey')
UsePackage('reticulate') 
UsePackage('tidyverse')
UsePackage('broman') #https://kbroman.org/knitr_knutshell/pages/Rmarkdown.html
UsePackage("rmdformats")
UsePackage('remotes')
UsePackage('summarytools')
UsePackage('DT')
UsePackage('Hmisc')
```

```{r, echo=FALSE, eval=TRUE, warning=FALSE, message=FALSE}
st_css()
```

**Loading datasets**
```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
#This table contains characteristics on the main final uses of energy in the 
#dwellings according to the socioeconomic characteristics of the households
df.encevi <- read.csv("input/encevi.csv")

#This table contains the characteristics of the dwellings inhabited by the
#members of the households surveyed.
df.dwelling <- read.csv("input/vivienda.csv")

#In this table are contained the characteristics of the households that 
#inhabit the dwellings.
df.household <- read.csv("input/hogar.csv")

#Importing data of summer months per region
df.summer.months <- read.csv("input/summer_by_state_cfe_052419.csv")
```

```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
# Get municipality codes ordered and cleaned, results are stored in 
# folder "/input", as INEGI_agem_short.csv, these data was provided 
# by INEGI and it is related to ENCEVI 2018 survey
#source('municipality_codes_inegi.R')

# Get tariffs and municipality codes by household ids, the results are 
# stored in folder "/input", as agem_tariff_byfolio.csv. 
source("merge_ids_agem_tariffs.R")
df.tariffs<- read.csv("input/agem_tariff_byfolio.csv")
```

**Cleaning and merging dataframes**
```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
names(df.encevi) <- tolower(colnames(df.encevi))
names(df.dwelling) <- tolower(colnames(df.dwelling)) 
names(df.household) <- tolower(colnames(df.household)) 

#Rename first column as folio. This piece of code corrects a bug in the command
colnames(df.encevi)[1] <- "folio"
colnames(df.dwelling)[1] <- "folio"
colnames(df.household)[1] <- "folio"
colnames(df.dwelling)[colnames(df.dwelling)=="entidad"] <- "state.id"
```

```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
# Merging ENCEVI and Dwelling datasets
df.enc.dwell <- merge(df.encevi, df.dwelling, by="folio")

# Merging encevi-dwelling dataframe with INEGI municipality codes dataframe
df.enc.dwell <- merge(df.enc.dwell, df.tariffs, by="folio")
```

```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
df.enc.dwell$region.f <- factor(df.enc.dwell$region,
                                levels = c(1, 2, 3),
                                labels = c("Extreme hot", "Temperate", "Tropical"))

df.enc.dwell$tipo_tarif.f <- factor(df.enc.dwell$tipo_tarif,
                               levels = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9),
                               labels = c("2", "1", "1A", "1B", "1C", "1D", 
                                          "1E", "1F", "DAC", "Don't know"))

df.enc.dwell$state.f <- factor(df.enc.dwell$state.id,
                               levels = c("1", "2", "3", "4", "5", "6", "7", 
                                          "8", "9", "10","11", "12", "13", "14", 
                                          "15", "16", "17", "18", "19", "20", 
                                          "21", "22", "23", "24", "25", "26", 
                                          "27", "28", "29", "30", "31", "32"),
                               labels = c("Aguascalientes", "Baja California", 
                                          "Baja California Sur", "Campeche", 
                                          "Coahuila", "Colima", "Chiapas", 
                                          "Chihuahua", "Mexico City", 
                                          "Durango", "Guanajuato", "Guerrero", 
                                          "Hidalgo", "Jalisco", "Mexico", 
                                          "Michoacan", "Morelos", "Nayarit", 
                                          "NuevoLeon", "Oaxaca", "Puebla", 
                                          "Queretaro", "Quintana Roo", 
                                          "San Luis Potosi", "Sinaloa", 
                                          "Sonora", "Tabasco", "Tamaulipas", 
                                          "Tlaxcala", "Veracruz", "Yucatan", 
                                          "Zacatecas"))
```

```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
df.summer.months <- subset(df.summer.months, year==2017, 
                        select=c('state.id', 'month', 'summer'))
#df.enc.dwell <- merge(df.enc.dwell, df.summer.months, by="state.id")
df.enc.dwell$dummy.house <- 1
```

# Descriptive Analysis
**Dwellings surveyed per region**
```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
# Survey design construction (mmc), this computes the statistical errors
df.enc.dwell$dummy.house <- 1

mmc <- svydesign(id=~upm, strata=~est_dis, 
                 data=df.enc.dwell, weights=~factor_sem)

## Estimación total de viviendas particulares habitadas 
tb.dwell <- svytotal(df.enc.dwell$dummy.house, mmc)

# Estimación por Región del total de viviendas particulares habitadas 
tb.dwell.region <- svyby(~dummy.house, by=~region.f, mmc, svytotal)  

ea01n <- tb.dwell[[1]]  # Estimación puntual 
er01n <- t(tb.dwell.region[2]) # Estimación puntual-Región 
ea01e <- SE(tb.dwell)   # Error estándar 
er01e <- t(data.frame(SE(tb.dwell.region)))  # Error estándar-Región 

colnames(tb.dwell.region)[colnames(tb.dwell.region)=="dummy.house"] <- "dwellings"
colnames(tb.dwell.region)[colnames(tb.dwell.region)=="region.f"] <- "region"

tb.dwell <- as.data.frame(tb.dwell)
tb.dwell.region$se <- round(tb.dwell.region$se,3)

datatable(tb.dwell.region, rownames = FALSE,
  options = list(
    dom = 't',
    scrollX = TRUE,
    fixedColumns = TRUE
  ))
```
- Number of dwellings surveyed: `r format(sum(df.enc.dwell$dummy.house), big.mark=",")` <br>
- Number of dwellings represented by the survey: `r format(tb.dwell$total, big.mark=",")`, 
standard error: `r format(tb.dwell$SE, big.mark=",", decimal.mark=".")`


**Dwellings connected to the grid**
```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
#Get dwellings connected to the grid
df.enc.dwell$grid <- ifelse(df.enc.dwell$electri %in% "1", 1 ,0) 
#Total dwellings with insulation
total.dwell.grid <- sum(df.enc.dwell$grid * df.enc.dwell$factor_sem)

#format(total.dwell.grid, big.mark=",", small.interval=3)
```
- Number of dwellings connected to the grid: `r format(total.dwell.grid, big.mark=",", small.interval=3)`*

```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE, results="asis"}
freq(df.enc.dwell$grid, weight = df.enc.dwell$factor_sem, report.nas = FALSE, 
     plain.ascii = FALSE, style = "simple", method = "render", 
     headings = FALSE, na.rm= TRUE)
```

**Dwellings connected to the grid by region**
<br> 
Number of dwellings connected to the grid by region
```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
mmc <- svydesign(id=~upm, data=df.enc.dwell, strata=~est_dis, weights=~factor_sem)
tb.grid.region <- cbind(svytable(~region.f+grid, design = mmc), 
                        prop.table(svytable(~region.f+grid, design = mmc)))
tb.grid.region <- as.data.frame(round(tb.grid.region, 4))
  
#colnames(tb.grid.region)[colnames(tb.grid.region)=="region.f"] <- "region"
#Printing table
tb.grid.region <- cbind(tb.grid.region[1], tb.grid.region[3], tb.grid.region[2], tb.grid.region[4])
tb.grid.region <- rbind(tb.grid.region, colSums(tb.grid.region))
colnames(tb.grid.region)<-c("dwellings (no grid)", "percent (no grid)", "dwellings (grid)", "percent (grid)")

tb.rownames <- rownames(tb.grid.region)
rownames(tb.grid.region) <- replace(tb.rownames, tb.rownames==4, "Total") 
#rownames(tb.grid.region) <- tb.rownames

datatable(tb.grid.region, rownames = T,
  options = list(
    dom = 't',
    scrollX = TRUE,
    fixedColumns = TRUE
  ))
```

```{r, echo=TRUE, eval=FALSE, warning=FALSE, message=FALSE}
mmc <- svydesign(id=~upm, data=df.enc.dwell, strata=~est_dis, weights=~factor_sem)

## Estimating number of dwellings connected to the grid by region
tb.grid.region <- svyby(~dummy.house, by=~region.f+grid, mmc, svytotal) 
colnames(tb.grid.region)[colnames(tb.grid.region) == "dummy.house"] <- "dwellings"

tb.grid.region <- merge(tb.grid.region, 
                        tb.dwell.region[ , c("region.f", "dummy.house")], 
                        by="region.f")

colnames(tb.grid.region)[colnames(tb.grid.region) == "dummy.house"] <- "dwellings.region"

tb.grid.region <- transform(tb.grid.region, 
                            percent.grid = myround(tb.grid.region$dwellings / 
                                                     tb.grid.region$dwellings.region, 3))

tb.grid.region$se <- myround(tb.grid.region$se,3)

##Printing table
datatable(tb.grid.region, rownames = FALSE,
  options = list(
    dom = 't',
    scrollX = TRUE,
    fixedColumns = TRUE
  ))
```

## Electricity Bill Dates
*For this analysis, the records of dwellings that are not connected to the grid are not considered.*
```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
df.dwell.grid <- subset(df.enc.dwell, grid==1)

df.dwell.grid$inicia1[df.dwell.grid$inicia1 == 99] <-  NA 
df.dwell.grid$mes_inic1[df.dwell.grid$mes_inic1 == 99] <-  NA
df.dwell.grid$inicia2[df.dwell.grid$inicia2 == 99] <-  NA
df.dwell.grid$mes_inic2[df.dwell.grid$mes_inic2 == 99] <-  NA
df.dwell.grid$final1[df.dwell.grid$final1 == 99] <-  NA 
df.dwell.grid$mes_final1[df.dwell.grid$mes_final1 == 99] <-  NA
df.dwell.grid$final2[df.dwell.grid$final2 == 99] <- NA
df.dwell.grid$mes_final2[df.dwell.grid$mes_final2 == 99]  <-  NA

df.dwell.grid$cons_med1[df.dwell.grid$cons_med1 >= 98888 ] <- NA
df.dwell.grid$cons_med2[df.dwell.grid$cons_med2 >= 98888 ] <- NA

```
*So, `r format(sum(df.enc.dwell$dummy.house)-sum(df.dwell.grid$dummy.house), decimal.mark=",")` records are discarted*

Calculating number of days of consumption of the first electricity bill
```{r, results="asis", echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
attach(df.dwell.grid)

bill.ini.date1 <- NA
bill.end.date1 <- NA

# The data was obtained from January 2018 to June 2018.
# So the bills could be from 2017 or 2018. As the survey does not report 
# the year of the electricity bill, it is calculated here
year_ini1 <- "2018"
year_end1 <- "2018"

# Case 1. If the initial period of the bill is from june to december, 
# it is assumed that the year of the initial period is 2017
year_ini1[mes_inic1 >= 6] <- 2017

# Case 2. If the final period of the bill is from july to december, 
# it is assumed that the year of the final period is 2017
year_end1[mes_final1 >= 7] <- 2017

# Case 3. If the initia month period of the bill is higher than the final month, 
# it is assumed that the year of the initial period is 2017
year_ini1[mes_inic1 > mes_final1] <- 2017

bill.ini.date1 <-  str_replace_all(paste(mes_inic1, "-", inicia1, "-", 
                                         year_ini1), pattern=" ", repl="")

bill.end.date1 <-  str_replace_all(paste(mes_final1, "-", final1, "-", 
                                         year_end1), pattern=" ", repl="")

bill.ini.date1 <- as.Date(as.character(bill.ini.date1), 
                                        format="%m-%d-%Y")

bill.end.date1 <- as.Date(as.character(bill.end.date1), 
                                        format="%m-%d-%Y")

bill.days1 <- as.integer((bill.end.date1 - bill.ini.date1))


# After obtaining the number of days of the period in the electricity bill. 
# There are still some special cases that are corrected here.
# Case 4. If the period in the electricity bill is longer than 1 year, the initial year is assumed to be 2018
year_ini1[bill.days1 >= 365 & (mes_inic1 <= mes_final1)] <- 2018

# Case 5. If the period in the electricity bill is negative, the initial year is assumed to be 2017
year_ini1[bill.days1 < 0] <- 2017

bill.end.date1 <-  str_replace_all(paste(mes_final1, "-", final1, "-", 
                                         year_end1), pattern=" ", repl="")

bill.ini.date1 <-  str_replace_all(paste(mes_inic1, "-" , inicia1, "-", 
                                         year_ini1), pattern=" ", repl="")

bill.end.date1 <-  str_replace_all(paste(mes_final1, "-" , final1, "-", 
                                         year_end1), pattern=" ", repl="")

bill.ini.date1 <- as.Date(as.character(bill.ini.date1), format="%m-%d-%Y")

bill.end.date1 <- as.Date(as.character(bill.end.date1), format="%m-%d-%Y")

bill.days1 <- as.integer((bill.end.date1 - bill.ini.date1))

bill.days1[bill.days1 < 0 ] <- NA
bill.days1[bill.days1 > 180 ] <- NA

desc.stat <- descr(bill.days1, style = "rmarkdown", stats = "common", transpose = TRUE, 
      headings = FALSE)

detach(df.dwell.grid)

desc.stat
```

```{r, echo=TRUE, eval=FALSE, warning=FALSE, message=FALSE, results="asis"}
svd.dwell <- svydesign(id=~upm, strata=~est_dis, data=df.enc.dwell, weights=~factor_sem)

## Estimating number of dwellings connected to the grid by region
svyby(~bill.days1, by=~grid, mmc, svymean, na.rm=TRUE) 

mean <- svymean(~bill.days1, svd.dwell, na.rm=TRUE)

variance <- svyvar(~bill.days1, svd.dwell, na.rm=TRUE)
#svytotal(~bill.days1, svd.dwell, na.rm=TRUE)
quantiles <- svyquantile(~bill.days1, svd.dwell, c(.25,.5,.75),ci=TRUE, na.rm=TRUE)
```

```{r, echo=TRUE, eval=FALSE, warning=FALSE, message=FALSE, results="asis"}
mean
variance
quantiles
sqrt(as.matrix(variance)[,1])
```

Calculating days of consumption of second electricity bill (users that pay two electricity bills each period)
```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE,  results="asis"}
attach(df.dwell.grid)

bill.ini.date2 <- NA
bill.end.date2 <- NA

# The data was obtained from January 2018 to June 2018.
# So the bills could be from 2017 or 2018. As the survey does
# not report the year of the electricity bill, it is calculated here
year_ini2 <- "2018"
year_end2 <- "2018"

# Case 1. If the initial period of the bill is from june to december, 
# it is assumed that the year of the initial period is 2017
year_ini2[mes_inic2 >= 6] <- 2017

# Case 2. If the final period of the bill is from july to december, 
# it is assumed that the year of the final period is 2017
year_end2[mes_final2 >= 7] <- 2017

# Case 3. If the initia month period of the bill is higher than the final  
# month, it is assumed that the year of the initial period is 2017
year_ini2[mes_inic2 > mes_final2] <- 2017

bill.ini.date2 <-  str_replace_all(paste(mes_inic2, "-", inicia1, "-", 
                                         year_ini2), pattern=" ", repl="")

bill.end.date2 <-  str_replace_all(paste(mes_final2, "-", final1, "-", 
                                         year_end2), pattern=" ", repl="")

bill.ini.date2 <- as.Date(as.character(bill.ini.date2), format="%m-%d-%Y")
bill.end.date2 <- as.Date(as.character(bill.end.date2), format="%m-%d-%Y")
bill.days2 <- as.integer((bill.end.date2 - bill.ini.date2))

# After obtaining the number of days of the period in the electricity bill. 
# There are still some special cases that are corrected here.

# Case 4. If the period in the electricity bill is longer than 1 year, 
# the initial year is assumed to be 2018
year_ini2[bill.days2 >= 365 & (mes_inic2 <= mes_final2)] <- 2018

# Case 5. If the period in the electricity bill is negative, 
# the initial year is assumed to be 2017
year_ini2[bill.days2 < 0] <- 2017

bill.end.date2 <-  str_replace_all(paste(mes_final2, "-", final1, "-", 
                                         year_end2), pattern=" ", repl="")

bill.ini.date2 <-  str_replace_all(paste(mes_inic2, "-", inicia1, "-", year_ini2),
                                                pattern=" ", repl="")

bill.end.date2 <-  str_replace_all(paste(mes_final2, "-", final1, "-", year_end2),
                                                pattern=" ", repl="")

bill.ini.date2 <- as.Date(as.character(bill.ini.date2), format="%m-%d-%Y")
bill.end.date2 <- as.Date(as.character(bill.end.date2), format="%m-%d-%Y")
bill.days2 <- as.integer((bill.end.date2 - bill.ini.date2))

bill.days2[bill.days2 < 0 ] <- NA
bill.days2[bill.days2 > 180 ] <- NA

desc.stat <- descr(bill.days2, style = "rmarkdown", stats = "common", 
                   transpose = TRUE, headings = FALSE)

detach(df.dwell.grid)

desc.stat 
```




```{r, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE, results="asis"}
#svyquantile(~bill.days1, svd.dwell, c(.25,.5,.75),ci=TRUE, na.rm=TRUE)
```


```{r, echo=TRUE, eval=FALSE, warning=FALSE, message=FALSE, results="asis"}
svyquantile(~bill.days1, mmc, c(.25,.5,.75),ci=TRUE, na.rm=TRUE)

svymean(~bill.days1, svd.dwell, na.rm=TRUE)
wtd.mean(df.enc.dwell$bill.days1, weights=df.enc.dwell$factor_sem,  na.rm=TRUE)
         
svyvar(~bill.days1, mmc, na.rm=TRUE)
wtd.var(df.enc.dwell$bill.days1, weights=df.enc.dwell$factor_sem,  na.rm=TRUE)

svyquantile(~bill.days1, mmc, c(0.0,.25,.5,.75,1.0),ci=TRUE, na.rm=TRUE)
wtd.quantile(df.enc.dwell$bill.days1, weights=df.enc.dwell$factor_sem, na.rm=TRUE)
```

```{r, echo=TRUE, eval=FALSE, warning=FALSE, message=FALSE, results="asis"}
#describe(df.enc.dwell$bill.days1, weights=df.enc.dwell$factor_sem, exclude.missing=TRUE, digits=3)
#svyhist(~bill.days1, mmc, main="Survey weighted - Bill days",col="purple",ylim=c(0,6e-2))
describe(df.enc.dwell$bill.days1, weights=NULL, exclude.missing=TRUE, digits=3)
```


```{r, echo=TRUE, eval=TRUE, warning = FALSE, message = FALSE, results = FALSE}
attach(df.enc.dwell)
df.bill.test2 <- subset(df.enc.dwell, bill.days2 >= 0, 
                        select=c('bill.days1', 'bill.days2', 'bill.ini.date1', 
                                 'bill.ini.date2', 'bill.end.date1',
                                 'bill.end.date2', 'cons_med1', 'cons_med2', 
                                 'cond_energ', 'local_com', 'elect_loc'))
detach(df.enc.dwell)
#sort(df.bill.error$bill.days1,decreasing=FALSE)
df.bill.test2[order(-df.bill.test2$bill.days2),]
```

Reference: https://cran.r-project.org/web/packages/summarytools/vignettes/Introduction.html

```{r, echo=FALSE, eval=TRUE, warning = FALSE, message = FALSE, results=FALSE}
attach(df.enc.dwell)
df.bill.error <- subset(df.enc.dwell, bill.days1 < 91 & bill.days1 > 24, 
                        select=c('bill.days1', 'mes_inic1', 'final1', 'mes_final1', 
                                 'inicia1', 'bill.ini.date1', 'bill.end.date1', 'cons_med1'))
detach(df.enc.dwell)
#sort(df.bill.error$bill.days1,decreasing=FALSE)
df.bill.error[order(df.bill.error$bill.days1),]
```

```{r, echo=FALSE, eval=TRUE, warning = FALSE, message = FALSE, results = FALSE}
attach(df.enc.dwell)
#df.bill.test <- subset(df.enc.dwell, bill.days1 >= 25, 
#                        select=c('bill.days1', 'mes_inic1', 'final1', 'mes_final1', 
#                                 'inicia1', 'bill.ini.date1', 'bill.end.date1', 'cons_med1')) 

df.bill.test <- subset(df.enc.dwell, bill.days1 >= 25 & local_com == 2, 
                        select=c('bill.days1', 'bill.ini.date1', 'bill.end.date1', 
                                 'cons_med1', 'cond_energ', 'local_com', 'elect_loc', 'cons_med2', 'factor_sem'))

detach(df.enc.dwell)
#sort(df.bill.error$bill.days1,decreasing=FALSE)
#df.bill.test$cons.day <-  df.bill.test /
df.bill.test <- transform(df.bill.test, bill.cons.day = df.bill.test$cons_med1 / df.bill.test$bill.days1)

df.bill.test[order(df.bill.test$bill.cons.day),]

describe(df.bill.test$bill.cons.day)
```

```{r}
UsePackage('weights')
#wpct(df.bill.test$bill.cons.day, df.bill.test$factor_sem)
describe(stdz(df.bill.test$bill.cons.day, df.bill.test$factor_sem))
```

# Tariffs

## Dwellings Divided by Tariff
```{r, results="asis"}
#write.csv(df.enc.dwell, "./output/encevi_dwelling.csv", row.names=TRUE, na="")
#show table of tariffs with missing values
freq(df.enc.dwell$tipo_tarif.f, report.nas = TRUE, style = "rmarkdown", weights = df.enc.dwell$factor_sem,
     headings = FALSE, na.rm = TRUE)
```

Reference: http://www.cfe.mx/tarifas/Pages/Tarifas.aspx
```{r, echo=FALSE, eval=TRUE, warning = FALSE, message = FALSE, results = FALSE}
#summary(df.enc.dwell$tariff)
#df.enc.dwell$tariff(is.na(df.enc.dwell$tariff)) <- "Don't know"
df.enc.dwell$tariff <- as.character(df.enc.dwell$tariff)
df.enc.dwell$tipo_tarif.f <- as.character(df.enc.dwell$tipo_tarif.f)

df.enc.dwell$tariff[df.enc.dwell$tariff==""] <- "Don't know"

df.enc.dwell$tariff.m <- recode(df.enc.dwell$tipo_tarif.f, "Don't know"= df.enc.dwell$tariff)
#df.enc.dwell$tariff.m <- df.enc.dwell$tariff.m %>% replace_na("Don't know")

df.enc.dwell$tipo_tarif.f <- factor(df.enc.dwell$tipo_tarif,
                               levels = c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9),
                               labels = c("2", "1", "1A", "1B", "1C", "1D", 
                                          "1E", "1F", "DAC", "Don't know"))
df.enc.dwell$tariff.m <- as.factor(df.enc.dwell$tariff.m)
df.enc.dwell$tariff.m <- factor(df.enc.dwell$tariff.m,
                               levels = c("2", "1", "1A", "1B", "1C", "1D", 
                                          "1E", "1F", "DAC", "Don't know"),
                               labels = c("2", "1", "1A", "1B", "1C", "1D", 
                                          "1E", "1F", "DAC", "Don't know"))
prop.table(table(df.enc.dwell$tipo_tarif.f, exclude = NULL))*100
prop.table(table(df.enc.dwell$tariff.m, exclude = NULL))*100
```


```{r, echo=TRUE, eval=TRUE, warning = FALSE, message = FALSE}
table(df.enc.dwell$state.f, df.enc.dwell$tariff.m, exclude = NULL)
```

```{r, echo=TRUE, eval=TRUE, warning = FALSE, message = FALSE}
table(df.enc.dwell$state.f, df.enc.dwell$tipo_tarif.f, exclude = NULL)
```
